<!DOCTYPE html>
<html>
<head>
  <title>Scriptorium Web UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .error { color: red; background: #ffe6e6; padding: 10px; margin: 10px 0; }
    .message { color: green; background: #e6ffe6; padding: 10px; margin: 10px 0; }
    .suggestion { color: #666; font-style: italic; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .button { background: #007cba; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px; }
    .button:hover { background: #005a87; }
    .section { margin: 20px 0; }
    .section h3 { margin-bottom: 10px; }
    .posts-table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    .posts-table th, .posts-table td { padding: 4px 8px; text-align: left; border: none; }
    .posts-table th { background-color: #f2f2f2; }
    .posts-table .post-id { text-align: right !important; font-family: monospace; min-width: 40px; }
  </style>
  <script>
    function ensureOverlay(id, text, bg) {
      let el = document.getElementById(id);
      if (!el) {
        el = document.createElement('div');
        el.id = id;
        el.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 16px 22px; border-radius: 8px; z-index: 9999; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
        document.body.appendChild(el);
      }
      el.style.background = bg;
      el.textContent = text;
      el.style.display = 'block';
      return el;
    }
    function showGeneratingPopup() { ensureOverlay('gen-popup', 'Generating view...', '#007bff'); }
    function showPreviewPopup() { ensureOverlay('preview-popup', 'Opening preview...', '#17a2b8'); }
    function previewView(viewName) {
      // Show lightweight popup while the new tab loads
      try { showPreviewPopup(); } catch(e) {}
      // Open preview in new tab with GET request
      window.open('/preview', '_blank');
    }
    
    function changeView(viewName) {
      // Submit form via AJAX to avoid URL change
      const formData = new FormData();
      formData.append('view_name', viewName);
      
      fetch('/change_view', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          // Reload the page to show the new view
          window.location.reload();
        } else {
          alert('Failed to change view');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error changing view');
      });
    }
  </script>
</head>
<body>
  <h1>Scriptorium Web UI</h1>
  
  <% if @error %>
    <div class="error">
      <strong>Error:</strong> <%= @error %>
      <% if @suggestion %>
        <div class="suggestion"><%= @suggestion %></div>
      <% end %>
    </div>
  <% end %>
  
  <% if @message %>
    <div class="message"><%= @message %></div>
  <% end %>

  <% if @api && @api.repo %>
    <div class="section">
      <h3>Repository loaded: <%= @api.repo.root %></h3>
      
      <div class="section">
        <h3>Views</h3>
        <% if @views && !@views.empty? %>
          <table>
            <tr>
              <th>Name <em style="font-size: 0.8em; font-weight: normal;">(Click to switch views)</em></th>
              <th>Title <em style="font-size: 0.8em; font-weight: normal;">(Click to configure)</em></th>
            </tr>
            <% @views.each do |view| %>
              <% if @current_view && view.name == @current_view.name %>
                <!-- Current view - entire row clickable but does nothing -->
                <tr style="background-color: #e3f2fd; cursor: pointer;" onclick="void(0)" title="Current view (clicking does nothing)">
                  <td style="color: #007cba; font-family: monospace;">
                    <%= view.name %>
                  </td>
                  <td style="color: #007cba;">
                    <%= view.title %> (Current)
                  </td>
                </tr>
              <% else %>
                <!-- Other views - entire row clickable -->
                <tr style="cursor: pointer;" onclick="changeView('<%= view.name %>')" title="Change to <%= view.name %>">
                  <td style="color: #007cba; font-family: monospace;">
                    <%= view.name %>
                  </td>
                  <td style="color: #007cba;">
                    <%= view.title %>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </table>
          
          <% if @current_view %>
            <div style="margin-top: 15px; padding: 10px; background-color: #f0f8ff; border: 1px solid #b0d4f1; border-radius: 3px;">
              <strong>Current view:</strong> <%= @current_view.name %>
              <a href="/view/<%= @current_view.name %>" class="button" style="margin-left: 10px; text-decoration: none;">View Dashboard</a>
              <a href="/asset_management" class="button" style="margin-left: 5px; text-decoration: none;">Asset Management</a>
              <a href="/theme_management" class="button" style="margin-left: 5px; text-decoration: none;">Theme Management</a>
            </div>
          <% end %>
        <% else %>
          <p>No views found</p>
        <% end %>
        
        <form method="post" action="/create_view" style="margin-top: 10px;">
          <input type="text" name="name" placeholder="View name" required>
          <input type="text" name="title" placeholder="View title" required>
          <input type="text" name="subtitle" placeholder="View subtitle" required>
          <button type="submit" class="button">Create new view</button>
        </form>
      </div>


    </div>
  <% else %>
    <div class="section">
      <h3>No repository loaded</h3>
      <form method="post" action="/create_repo">
        <input type="text" name="name" placeholder="Repository name" value="scriptorium-TEST" required>
        <button type="submit" class="button">Create Repository</button>
      </form>
    </div>
  <% end %>
</body>
</html> 